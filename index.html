// Near the top of your <script> block, ensure these are defined:
// const GOOGLE_SHEET_WEB_APP_URL = 'YOUR_URL_HERE';
// const customerSelect = document.getElementById('customerSelect');
// const skuSelect = document.getElementById('skuSelect');
// const skuInputGroup = document.getElementById('skuInputGroup');
// const resultElement = document.getElementById('result');

customerSelect.addEventListener('change', function() {
    console.log('Customer selected:', this.value); // New log
    fetchSKUsForCustomer(this.value);
});

async function fetchSKUsForCustomer(customerName) {
    console.log('fetchSKUsForCustomer called with customer:', customerName); // New log
    skuSelect.innerHTML = '<option value="">-- Select SKU --</option>'; 
    skuInputGroup.style.display = 'none'; 
    // updateScannerReadyMessage(); // Called at the end now

    if (!customerName) {
        console.log('No customerName provided to fetchSKUsForCustomer, exiting.'); // New log
        updateScannerReadyMessage();
        return;
    }

    resultElement.textContent = `Loading SKUs for ${customerName}...`;
    console.log(`Attempting to fetch SKUs for: ${customerName}`); // New log
    try {
        const fetchUrl = `<span class="math-inline">\{GOOGLE\_SHEET\_WEB\_APP\_URL\}?action\=getSKUsForCustomer&customer\=</span>{encodeURIComponent(customerName)}`;
        console.log('Fetching from URL:', fetchUrl); // New log

        const response = await fetch(fetchUrl);
        console.log('Fetch response received. response.ok:', response.ok, 'response.status:', response.status); // New log

        if (response.ok) {
            const data = await response.json();
            console.log('Parsed JSON data from script:', data); // New log

            if (data.status === "success" && data.data && data.data.length > 0) {
                console.log('SKUs found. Populating dropdown.'); // New log
                data.data.forEach(sku => {
                    const option = document.createElement('option');
                    option.value = sku; option.textContent = sku;
                    skuSelect.appendChild(option);
                });
                skuInputGroup.style.display = 'flex'; 
                resultElement.textContent = `SKUs loaded for ${customerName}. Ready for action.`;
            } else if (data.status === "success" && (!data.data || data.data.length === 0)) {
                console.log('Success, but no SKUs returned for this customer.'); // New log
                resultElement.textContent = `No SKUs configured for ${customerName}. Ready for action.`;
            } else { 
                console.warn('Received success status but data format unexpected or message indicates issue:', data.message); // New log
                resultElement.textContent = `Info loading SKUs: ${data.message || 'No specific SKU data returned.'}`;
            }
        } else {
            let errorDetail = `Server responded with status ${response.status}.`;
            try {
                 const errText = await response.text(); 
                 console.error('Server error response text (from !response.ok):', errText); // New log
                 errorDetail += ` Response: ${errText.substring(0,100)}`; 
            } catch(e) {
                 console.error('Could not read error response text:', e); // New log
            }
            resultElement.textContent = `Error loading SKUs: ${errorDetail}. Check script deployment ('Anyone' access) and URL.`;
            console.error('Server error fetching SKUs (full response object):', response); // New log
        }
    } catch (error) { 
        console.error('Catch block: Network or parsing error fetching SKUs:', error); // New log
        resultElement.textContent = `Network error loading SKUs: ${error.message}. Check console and Apps Script URL.`;
    }
    updateScannerReadyMessage(); 
}